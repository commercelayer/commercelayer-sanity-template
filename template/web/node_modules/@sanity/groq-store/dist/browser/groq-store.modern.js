import e from"groq";export{default as groq}from"groq";import t from"fast-deep-equal";import{throttle as r}from"throttle-debounce";import{parse as n,evaluate as o}from"groq-js";import{applyPatch as i}from"mendoza";function s(){return(s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function a(e,t,r){const{projectId:n,dataset:o,token:i}=t,s=new e(`https://${n}.api.sanity.io/v1/data/listen/${o}?query=*&effectFormat=mendoza`,{withCredentials:!0,headers:i?{Authorization:"Bearer "+i}:void 0});var a;return s.addEventListener("welcome",r.open,!1),s.addEventListener("mutation",(a=r.next,e=>{let t;try{t=JSON.parse(e.data)}catch(e){return}a(t)}),!1),s.addEventListener("channelError",e=>{let t;s.close();try{t=JSON.parse(e.data)}catch(e){return void r.error(new Error("Unknown error parsing listener message"))}r.error(new Error(t.message||t.error||"Listener returned HTTP "+t.statusCode))},!1),s.addEventListener("error",()=>{const e="undefined"!=typeof window&&window.location.origin;r.error(new Error("Error establishing listener - check that the project ID and dataset are correct"+(e?`, and that the CORS-origin (${e}) is allowed`:"")))},!1),{unsubscribe:()=>Promise.resolve(s.close())}}function c(e){return e._id.startsWith("drafts.")?e._id.slice(7):e._id}function u(e,t){const r=s({},e);return delete r._rev,i(r,t)}function d(){return Promise.resolve()}let l,f=e=>e;const p=async function({projectId:e,dataset:t,token:r,documentLimit:n}){const o=`https://${e}.api.sanity.io/v1/data/export/${t}`,i=r?{Authorization:"Bearer "+r}:void 0,s=await fetch(o,{credentials:"include",headers:i});if(200!==s.status)throw new Error("Error streaming dataset: "+("object"==typeof(a=await s.json())&&"error"in a&&"message"in a?a.message||a.error:"<unknown error>"));var a;const c=function(e){if(!e)throw new Error("Failed to read body from response");let t,r=!1;function n(){r=!0,t&&t.cancel()}return new ReadableStream({start(o){t=e.getReader();const i=new TextDecoder;let s="";t.read().then(async function e(a){if(a.done){if(r)return;return s=s.trim(),0===s.length||o.enqueue(JSON.parse(s)),void o.close()}s+=i.decode(a.value,{stream:!0});const c=s.split("\n");for(let e=0;e<c.length-1;++e){const t=c[e].trim();if(0!==t.length)try{o.enqueue(JSON.parse(t))}catch(e){return o.error(e),void n()}}if(s=c[c.length-1],t)try{e(await t.read())}catch(e){o.error(e)}}).catch(e=>o.error(e))},cancel:n})}(s.body).getReader(),u=[];let d,l;do{if(d=await c.read(),l=d.value,m(l))throw new Error("Error streaming dataset: "+l.error);if(l&&!l._id.startsWith("_.")&&u.push(l),n&&u.length>n)throw c.cancel("Reached document limit"),new Error(`Error streaming dataset: Reached limit of ${n} documents`)}while(!d.done);return u};function m(e){return!!e&&"error"in e&&"object"==typeof e.error&&null!==e.error&&"description"in e.error&&"string"==typeof e.error.description&&!("_id"in e)}function h(i){if(function(){const e=["EventSource","ReadableStream","fetch"].filter(e=>!(e in window));if(e.length>0)throw new Error("Browser not supported. Missing browser APIs: "+e.join(", "))}(),i.token)throw new Error("`token` option not currently supported in browser");return function(i,p){let m=[];const h=r(i.subscriptionThrottleMs||50,function(){w.forEach(y)}),w=[];let v;async function g(){v||(v=function(e,t,{getDocuments:r,EventSource:n}){const{projectId:o,dataset:i,listen:l,overlayDrafts:f,documentLimit:p}=e;if(!l)return{unsubscribe:d,loaded:r({projectId:o,dataset:i,documentLimit:p}).then(j).then(d)};const m=new Map;let h;const w=[];let v,g;const b=new Promise((e,t)=>{v=e,g=t});let y,E,_;return{unsubscribe:a(n,e,{next:function(e){h?(function(e){if(!e.effects||e.documentId.startsWith("_."))return;const t=m.get(e.documentId)||null;!function(e,t){const r=m.get(e),n=h||[],o=r?n.indexOf(r):-1;-1===o&&t?(n.push(t),m.set(e,t)):t?(n.splice(o,1,t),m.set(e,t)):(n.splice(o,1),m.delete(e))}(e.documentId,u(t,e.effects.apply))}(e),function(e,t){clearTimeout(_),E!==t.transactionId&&y?(j(y),E=void 0):(E=t.transactionId,y=e.slice()),_=setTimeout(j,25,e.slice())}(h,e)):w.push(e)},open:async function(){const e=await r({projectId:o,dataset:i,documentLimit:p});h=function(e,t){const r=new Map;return t.forEach(e=>{const t=r.get(e.documentId)||[];t.push(e),r.set(e.documentId,t)}),r.forEach((t,r)=>{const n=e.find(e=>e._id===r);if(!n)return void console.warn("Received mutation for missing document %s",r);let o=!1,i=n;t.forEach(e=>{o=o||e.previousRev===n._rev,o&&e.effects&&(i=u(i,e.effects.apply))}),e.splice(e.indexOf(n),1,i)}),e}(e,w),h.forEach(e=>m.set(e._id,e)),j(h),v()},error:e=>g(e)}).unsubscribe,loaded:b};function j(e){y=void 0,_=void 0,E=void 0,t(f?function(e){const t=new Map;return e.forEach(e=>{const r=t.get(c(e));e._id.startsWith("drafts.")?t.set(c(e),function(e){return s({},e,{_id:c(e)})}(e)):r||t.set(e._id,e)}),Array.from(t.values())}(e):e)}}(i,e=>{m=e,h()},p)),await v.loaded}async function b(e,t){await g();const r=n(e);return(await o(r,{dataset:m,params:t})).get()}function y(e){return b(e.query,e.params).then(r=>{"previousResult"in e&&t(e.previousResult,r)||(e.previousResult=r,e.callback(void 0,r))}).catch(t=>{e.callback(t)})}return{query:b,getDocument:async function(t){return await g(),b(e(l||(l=f`*[_id == $id][0]`)),{id:t})},getDocuments:async function(e){return await g(),b(`[${e.map(e=>`*[_id == "${e}"][0]`).join(",\n")}]`)},subscribe:function(e,t,r){if(!i.listen)throw new Error("Cannot use `subscribe()` without `listen: true`");const n={query:e,params:t,callback:r};w.push(n);let o=!1;return y(n),{unsubscribe:()=>(o||(o=!0,w.splice(w.indexOf(n),1)),Promise.resolve())}},close:function(){return h.cancel(),v?v.unsubscribe():Promise.resolve()}}}(i,{EventSource:window.EventSource,getDocuments:p})}export{h as groqStore};
//# sourceMappingURL=groq-store.modern.js.map
